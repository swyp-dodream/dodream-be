version: '3.8'

services:
  dodream-app:
    # Docker Hub에서 최신 이미지 사용
    # MySQL, Redis, Qdrant, Elasticsearch는 서버에서 별도로 관리
    image: ${DOCKER_USERNAME}/dodream-backend:latest
    container_name: dodream-app
    # 컨테이너가 예상치 못하게 종료되면 자동 재시작
    restart: unless-stopped
    # 호스트 네트워크를 사용하여 localhost로 연결 (서버에서 별도 관리하는 DB와 연결)
    network_mode: host
    environment:
      # Spring Boot 프로파일 설정 (운영 환경)
      - SPRING_PROFILES_ACTIVE=prod
      # 서버에서 별도로 관리하는 MySQL 연결 (localhost 사용)
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      # Redis 설정 (서버에서 별도 관리, localhost 사용)
      - SPRING_DATA_REDIS_HOST=localhost
      - SPRING_DATA_REDIS_PORT=6379
      # Elasticsearch 설정 (서버에서 별도 관리, localhost 사용)
      - SPRING_ELASTICSEARCH_URIS=http://localhost:9200
      # OAuth2 설정
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      # JWT 설정
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION=1800000
      - JWT_REFRESH_TOKEN_EXPIRATION=604800000
      # NCP Clova 설정
      - NCP_CLOVA_API_KEY=${NCP_CLOVA_API_KEY}
    healthcheck:
      # 헬스체크: 30초마다 애플리케이션 상태 확인
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s       # 30초마다 체크
      timeout: 10s        # 10초 안에 응답 없으면 실패
      retries: 3          # 3번 연속 실패하면 unhealthy 상태
      start_period: 60s   # 시작 후 60초 동안은 실패해도 카운트 안 함
